{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Your Preferences</title>
{% endblock meta %}
{% block content %}
<!-- Include Navbar -->
{% include 'navbar.html' %}

<!-- Main Container -->
<div class="container mx-auto mt-16">  
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold mt-4 ml-4">Your Preferences</h2>
        <button class="bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full whitespace-nowrap mt-4 mr-4" id="addPreferenceBtn">
            + Add Preference
        </button>
    </div>

    <!-- Preferences Display -->
    <div class="row" id="preferences-container">
        {% for preference in preferences %}
        <div class="col-md-4 mb-4" id="preference-{{ preference.id }}">
            <div class="card">
                <div class="card-body flex justify-between">
                    <h5 class="card-title">{{ preference.preference }}</h5>
                    <button class="text-red-500 hover:text-red-700" onclick="deletePreference('{{ preference.id }}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12" id="empty-message">
            <p class="text-center">No preferences added yet. Click the button above to add your first preference!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Products Matching Your Preferences -->
    <div id="products-section" class="mt-8" style="display: {% if preferences %}block{% else %}none{% endif %};">
        <h3 class="text-lg font-bold mb-4">Products Matching Your Preferences</h3>
        <div id="product_entry_cards" class="flex overflow-x-auto space-x-4 px-4 py-6">
            {% for product_entry in product_entries %}
                <div class="bg-[#f7f7f7] shadow-md mb-6 flex flex-col border-2 border-black-500 rounded-lg w-full min-w-[250px] max-w-[300px] h-auto">
                    <div class="p-3">
                        <h3 class="font-bold text-lg mb-1">{{ product_entry.item }}</h3>
                        <p class="text-gray-600">{{ product_entry.description }}</p>
                    </div>
                </div>
            {% empty %}
            <p class="text-center">No products match your preferences.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal for Add Preference -->
<div id="preferenceCrudModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50 flex">
    <div id="preferenceCrudModalContent" class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md transform scale-95 opacity-0 transition-transform transition-opacity">
        <div class="flex items-center justify-between pb-4 border-b">
            <h3 class="text-xl font-semibold text-gray-900">Add Your Own Preference</h3>
            <button type="button" id="closePreferenceModalBtn" class="text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg p-2">
                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <div class="mt-6">
            <form id="PreferenceForm" method="POST" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="preference_name" class="block text-sm font-medium text-gray-700">Preference</label>
                    <input type="text" id="preference_name" name="preference_name" 
                        class="block w-full mt-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" 
                        placeholder="Enter your preference" required>
                    <span id="preferenceError" class="text-red-500 text-xs hidden">Preference Name is required.</span>
                </div>
            </form>
        </div>

        <div class="mt-6 flex justify-end space-x-2">
            <button type="button" id="cancelPreferenceButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
            <button type="submit" id="submitPreferenceEntry" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="fixed inset-0 z-50 hidden justify-center items-center bg-black bg-opacity-50 flex">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Delete Preference</h3>
        <p>Are you sure you want to delete this preference?</p>
        <div class="mt-6 flex justify-end space-x-2">
            <button id="cancelDeleteButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
            <button id="confirmDeleteButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Delete</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let preferenceIdToDelete = null;

    // Function to show the delete confirmation modal
    function showDeleteConfirmationModal(preferenceId) {
        preferenceIdToDelete = preferenceId; 
        const modal = document.getElementById('deleteConfirmationModal');
        modal.classList.remove('hidden');
    }

    // Function to hide the delete confirmation modal
    function hideDeleteConfirmationModal() {
        const modal = document.getElementById('deleteConfirmationModal');
        modal.classList.add('hidden');
        preferenceIdToDelete = null;
    }

    // Event listener for delete buttons
    window.deletePreference = function(preferenceId) {
        showDeleteConfirmationModal(preferenceId);
    };

    // Event listener for confirming the deletion
    document.getElementById('confirmDeleteButton').addEventListener('click', function() {
        if (preferenceIdToDelete) {
            fetch(`/preferences/delete-ajax/${preferenceIdToDelete}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the deleted preference from the DOM
                    document.getElementById(`preference-${preferenceIdToDelete}`).remove();

                    // If no preferences left, hide the products section
                    if (document.getElementById('preferences-container').children.length === 0) {
                        document.getElementById('products-section').style.display = 'none';
                    }

                    hideDeleteConfirmationModal();
                } else {
                    console.error('Error deleting preference');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });

    // Event listener for canceling the deletion
    document.getElementById('cancelDeleteButton').addEventListener('click', hideDeleteConfirmationModal);

    // Show Add Preference Modal
    function showPreferenceModal() {
        const modal = document.getElementById('preferenceCrudModal');
        const modalContent = document.getElementById('preferenceCrudModalContent');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 50);
    }

    // Hide Add Preference Modal
    function hidePreferenceModal() {
        const modal = document.getElementById('preferenceCrudModal');
        const modalContent = document.getElementById('preferenceCrudModalContent');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150);
    }

    // Event listeners for opening and closing the Add Preference modal
    document.getElementById('addPreferenceBtn').addEventListener('click', showPreferenceModal);
    document.getElementById('closePreferenceModalBtn').addEventListener('click', hidePreferenceModal);
    document.getElementById('cancelPreferenceButton').addEventListener('click', hidePreferenceModal);

    // Handle form submission for adding preferences
    document.getElementById('submitPreferenceEntry').addEventListener('click', function(e) {
        e.preventDefault();

        const preferenceName = document.getElementById('preference_name').value.trim();
        const form = document.getElementById('PreferenceForm');

        // Validate the input
        if (!preferenceName) {
            document.getElementById('preferenceError').classList.remove('hidden');
            return;
        } else {
            document.getElementById('preferenceError').classList.add('hidden');
        }

        // Prepare form data
        const formData = new FormData(form);

        // Send AJAX request to add the new preference
        fetch("{% url 'preference:add_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Hide the empty message if it exists
                const emptyMessage = document.getElementById('empty-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }

                // Dynamically append the new preference to the list
                const newPreference = `
                    <div id="preference-${data.id}" class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body flex justify-between">
                                <h5 class="card-title">${data.preference_name}</h5>
                                <button class="text-red-500 hover:text-red-700" onclick="deletePreference('${data.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('preferences-container').insertAdjacentHTML('afterbegin', newPreference);

                // Show the products section after a new preference is added
                document.getElementById('products-section').style.display = 'block';

                hidePreferenceModal();
                form.reset();
            } else {
                console.error('Failed to add preference');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>

{% endblock content %}
