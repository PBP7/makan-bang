{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Product Reviews</title>
{% endblock meta %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <!-- Header and Add Review Button -->
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Product Reviews</h1>
    <div class="flex justify-center mb-4">
        <button onclick="toggleModal('productSelectModal')" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">
            Add Review
        </button>
    </div>

    <!-- Product Selection Modal -->
    <div id="productSelectModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-800 bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/4 md:w-1/2 lg:w-1/3 p-6 max-h-[80vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center border-b pb-3 mb-3">
                <h2 class="text-xl font-semibold text-gray-800">Select Product</h2>
                <button onclick="toggleModal('productSelectModal')" class="text-gray-400 hover:text-gray-600">
                    ✖
                </button>
            </div>

            <!-- Product Cards (from catalog) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for product in products %}
                <div class="border rounded-lg p-4 shadow hover:shadow-lg transition duration-200 cursor-pointer" onclick="selectProduct('{{ product.pk }}', '{{ product.item }}')">
                    <img src="{{ product.picture_link }}" alt="{{ product.item }}" class="h-32 w-full object-cover rounded-md mb-2">
                    <h3 class="font-bold text-gray-700">{{ product.item }}</h3>
                    <p class="text-sm text-gray-600">{{ product.kategori }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>


    <div id="addReviewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-800 bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/4 md:w-1/2 lg:w-1/3 p-6">
            <!-- Modal Header -->
            <div class="flex justify-between items-center border-b pb-3 mb-3">
                <h2 class="text-xl font-semibold text-gray-800">Add Review for <span id="selectedProductName"></span></h2>
                <button onclick="toggleModal('addReviewModal')" class="text-gray-400 hover:text-gray-600">
                    ✖
                </button>
            </div>

            <!-- Rating and review_text Form -->
            <form id="reviewForm" method="POST" action="{% url 'rateNreview:add_review' %}">
                {% csrf_token %}
                <input type="hidden" id="product_id" name="product_id">

                <!-- Rating -->
                <label for="rating" class="block text-gray-700 font-semibold mb-2">Rating (1-5):</label>
                <select id="rating" name="rating" class="w-full border border-gray-300 rounded-md p-2 mb-4" required>
                    {% for i in "12345" %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>

                <!-- review_text -->
                <label for="review_text" class="block text-gray-700 font-semibold mb-2">Add a review:</label>
                <textarea id="review_text" name="review_text" rows="3" 
                          class="w-full border border-gray-300 rounded-md p-2 mb-4" 
                          placeholder="Write your review_text here..."></textarea>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('addReviewModal')" 
                            class="bg-gray-400 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">
                        Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Product Review Modal -->
    


    <!--Edit Review Modal -->
    <!--Edit Review Modal -->
    

    

    <!-- Display User Reviews -->
   <!-- Display User Reviews -->
    <div class="mt-8" id="userReviews">
        <h2 class="text-2xl font-semibold mb-4">Your Reviews</h2>
        <div id="userReviewsContent">
            {% for review in user_reviews %}
            <div class="border rounded-lg p-4 mb-4">
                <h3 class="font-bold text-gray-700 cursor-pointer" onclick="loadProductReviews('{{ review.product.pk }}')">{{ review.product.item }}</h3>
                <p class="text-gray-600">Rating: {{ review.rating }}</p>
                <p class="text-gray-600">Review: {{ review.review_text }}</p>
                
                <!-- Edit Button -->
                <button onclick="editReview('{{ review.product.pk }}', '{{ review.product.item }}', '{{ review.rating }}', '{{ review.review_text }}')" 
                        class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    Edit Review
                </button>
                
                <!-- Delete Button -->
                <form action="{% url 'rateNreview:delete_review' review.product.pk %}" method="post" class="inline-block mt-2">
                    {% csrf_token %}
                    <button type="submit" 
                            class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600">
                        Delete Review
                    </button>
                </form>
           </div>
           {% endfor %}
       </div>
    </div>
    <!-- Edit Review Modal -->
    <!-- Edit Review Modal -->
    <div id="editReviewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-800 bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/4 md:w-1/2 lg:w-1/3 p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-3">
                <h2 class="text-xl font-semibold text-gray-800">Edit Review for <span id="editReviewProductName"></span></h2>
                <button onclick="toggleModal('editReviewModal')" class="text-gray-400 hover:text-gray-600">✖</button>
            </div>
            
            <form id="editReviewForm">
                {% csrf_token %}
                <input type="hidden" id="editReviewProductId" name="product_id">

                <!-- Rating Field -->
                <label for="edit_rating" class="block text-gray-700 font-semibold mb-2">Rating (1-5):</label>
                <select id="edit_rating" name="rating" class="w-full border rounded-md p-2 mb-4" required>
                    {% for i in "12345" %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>

                <!-- Review Text Field -->
                <label for="edit_review_text" class="block text-gray-700 font-semibold mb-2">Review:</label>
                <textarea id="edit_review_text" name="review_text" rows="3" 
                        class="w-full border rounded-md p-2 mb-4" 
                        placeholder="Edit your review here..." required></textarea>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('editReviewModal')" 
                            class="bg-gray-400 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-500">Cancel</button>
                    <button type="submit" 
                            class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    
    


</div>

<script>
    // Toggle modal visibility
    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.toggle('hidden');
        modal.classList.toggle('flex');
    }
   

    // Select a product to review
    function selectProduct(productId, productName) {
    // Set the hidden input for the selected product ID in the review form
        document.getElementById('product_id').value = productId;
        // Set the displayed product name
        document.getElementById('selectedProductName').innerText = productName;
        
        // Toggle modals: hide the product selection and show the add/edit review modal
        toggleModal('productSelectModal');
        toggleModal('addReviewModal');
}

    // Edit a review - populate the modal with existing review data
    // Load product reviews and rating into the edit modal
    function editReview(productId, productName, rating, reviewText) {
        document.getElementById('editReviewProductId').value = productId;
        document.getElementById('editReviewProductName').innerText = productName;
        document.getElementById('edit_rating').value = rating;
        document.getElementById('edit_review_text').value = reviewText;
        
        toggleModal('editReviewModal');
    }
    

    // Add a new review field in the edit modal
   

    // Submit all changes for the rating and reviews
    function submitEditReview() {
        const editReviewForm = document.getElementById('editReviewForm');
        const formData = new FormData(editReviewForm);
        const productId = formData.get('product_id');
        
        fetch(`/rateNreview/edit_review/${productId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide the modal
                toggleModal('editReviewModal');
                
                // Update the review display without a page reload
                const updatedReview = document.querySelector(`#review-${productId}`);
                if (updatedReview) {
                    const rating = formData.get('rating');
                    const reviewText = formData.get('review_text');
                    
                    // Update the DOM with the new rating and review text
                    updatedReview.querySelector('.review-rating').textContent = `Rating: ${rating}`;
                    updatedReview.querySelector('.review-text').textContent = `Review: ${reviewText}`;
                }
                
                alert("Review updated successfully!");  // Optional feedback for user
            } else {
                alert("Failed to update review.");
            }
        })
        .catch(error => {
            console.error('Error updating review:', error);
            alert("An error occurred. Please try again.");
        });
    }
    
    
    

    // Delete a specific review
    function deleteReview(productId) {
        fetch(`/rateNreview/delete_review/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Review deleted successfully');
                location.reload();
            } else {
                alert('Failed to delete review.');
            }
        })
        .catch(error => console.error('Error deleting review:', error));
    }
    


    // Dynamically add a new review text field
    function addAdditionalReview() {
        const additionalReviews = document.getElementById('additionalReviews');
        const newReviewField = document.createElement('textarea');
        newReviewField.name = 'additional_review_text[]';
        newReviewField.rows = 3;
        newReviewField.classList.add('w-full', 'border', 'border-gray-300', 'rounded-md', 'p-2', 'mb-4');
        newReviewField.placeholder = 'Write additional review...';
        additionalReviews.appendChild(newReviewField);
    }
    function loadProductReviews(productId, productName) {
        document.getElementById('modalProductName').innerText = productName;
        toggleModal('productReviewModal');
    
        // Fetch reviews and rating details for the selected product
        fetch(`/rateNreview/product/${productId}/reviews`)
            .then(response => response.json())
            .then(data => {
                // Populate Product Details in the modal
                document.getElementById('modalProductCategory').innerText = data.kategori;
                document.getElementById('modalProductLocation').innerText = data.lokasi;
                document.getElementById('modalProductRating').innerText = data.rating || 'No ratings';
    
                // Clear existing reviews
                const reviewsContainer = document.getElementById('modalReviews');
                reviewsContainer.innerHTML = '';
    
                // Populate reviews
                data.reviews.forEach(review => {
                    const reviewElement = document.createElement('div');
                    reviewElement.classList.add('border', 'p-4', 'rounded-md', 'shadow-sm');
                    reviewElement.innerHTML = `
                        <p><strong>Review:</strong> ${review.review_text}</p>
                    `;
                    reviewsContainer.appendChild(reviewElement);
                });
            })
            .catch(error => console.error('Error loading reviews:', error));
    }
    
</script>
{% endblock content %}
