{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Rate and Review Products</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="container mx-auto px-4 py-8 mt-16">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Rate and Review Products</h1>

    <!-- Product Grid -->
    <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for product in products %}
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <img src="{{ product.picture_link }}" alt="{{ product.name }}" class="w-full h-48 object-cover">
            <div class="p-4">
                <h2 class="font-bold text-xl mb-2 truncate">{{ product.name }}</h2>
                <p class="text-gray-700 text-base mb-2 truncate">{{ product.restaurant }}</p>
                <p class="text-gray-600 text-sm mb-4">{{ product.category }}</p>
                <button onclick="showReviewModal('{{ product.id }}', '{{ product.name }}')" 
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full">
                    Review
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalProductName"></h3>
                <div class="mt-2 px-7 py-3">
                    <form id="reviewForm">
                        <input type="hidden" id="productId" name="product_id">
                        <div class="mb-4">
                            <label for="rating" class="block text-gray-700 text-sm font-bold mb-2">Rating:</label>
                            <select id="rating" name="rating" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="1">1 Star</option>
                                <option value="2">2 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="5">5 Stars</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="reviewText" class="block text-gray-700 text-sm font-bold mb-2">Review:</label>
                            <textarea id="reviewText" name="review_text" rows="4" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                        </div>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                            Submit Review
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showReviewModal(productId, productName) {
        document.getElementById('modalProductName').textContent = productName;
        document.getElementById('productId').value = productId;
        document.getElementById('reviewModal').classList.remove('hidden');
    }

    document.getElementById('reviewForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        
        fetch('{% url "rateNreview:add_review" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Review submitted successfully!');
                document.getElementById('reviewModal').classList.add('hidden');
                document.getElementById('reviewForm').reset();
            } else {
                alert('Error submitting review: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        var modal = document.getElementById('reviewModal');
        if (event.target == modal) {
            modal.classList.add('hidden');
        }
    }
</script>
{% endblock content %}
